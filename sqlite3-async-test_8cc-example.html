<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>kvtest: sqlite3-async-test.cc</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>sqlite3-async-test.cc</h1><div class="fragment"><pre class="fragment"><span class="preprocessor">#include &lt;assert.h&gt;</span>
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;pthread.h&gt;</span>
<span class="preprocessor">#include &lt;iostream&gt;</span>
<span class="preprocessor">#include &lt;queue&gt;</span>

<span class="preprocessor">#include &quot;base-test.hh&quot;</span>
<span class="preprocessor">#include &quot;suite.hh&quot;</span>
<span class="preprocessor">#include &quot;sqlite-base.hh&quot;</span>

<span class="keyword">using namespace </span>kvtest;

<span class="preprocessor">#define MAX_DRAIN 25000</span>
<span class="preprocessor"></span>
<span class="keyword">class </span>DBOperation {
<span class="keyword">public</span>:
    <span class="keyword">virtual</span> <span class="keywordtype">bool</span> execute(<a name="_a0"></a><a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a> *db) {}
};

<span class="keyword">class </span>ResetOperation : <span class="keyword">public</span> DBOperation {
<span class="keyword">public</span>:

    ResetOperation(<a name="_a1"></a><a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *c) {
        cb = c;
    }

    <span class="keywordtype">bool</span> execute(<a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a> *db) {
        db-&gt;<a name="a2"></a><a class="code" href="classkvtest_1_1_sqlite3.html#aa0a653a09e101b0caaafe82af62bc037" title="Rollback a transaction (unless not currently in one).">rollback</a>();
        db-&gt;<a name="a3"></a><a class="code" href="classkvtest_1_1_sqlite3.html#ad3787e4ee7f6bc0e0af610d43455054f" title="Reset database to a clean state.">reset</a>();
        <span class="keywordtype">bool</span> rv = <span class="keyword">true</span>;
        cb-&gt;callback(rv);
    }

<span class="keyword">private</span>:
    <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *cb;
};

<span class="keyword">class </span>NOOPOperation : <span class="keyword">public</span> DBOperation {
<span class="keyword">public</span>:

    NOOPOperation(<a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *c) {
        cb = c;
    }

    <span class="keywordtype">bool</span> execute(<a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a> *db) {
        <span class="keywordtype">bool</span> rv = <span class="keyword">true</span>;
        cb-&gt;<a name="a4"></a><a class="code" href="classkvtest_1_1_callback.html#a07c80f0c039c79725f7f701010d3455b" title="Method called on callback.">callback</a>(rv);
    }

<span class="keyword">private</span>:
    <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *cb;
};

<span class="keyword">class </span>SetOperation : <span class="keyword">public</span> DBOperation {
<span class="keyword">public</span>:

    SetOperation(std::string &amp;k, std::string &amp;v,
                 <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *c) {
        key = k;
        value = v;
        cb = c;
    }

    <span class="keywordtype">bool</span> execute(<a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a> *db) {
        db-&gt;<a name="a5"></a><a class="code" href="classkvtest_1_1_sqlite3.html#a3c4122dd29d8bd6f9039654f95504864" title="Overrides set().">set</a>(key, value, *cb);
    }

<span class="keyword">private</span>:
    std::string     key;
    std::string     value;
    <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *cb;
};

<span class="keyword">class </span>GetOperation : <span class="keyword">public</span> DBOperation {
<span class="keyword">public</span>:

    GetOperation(std::string &amp;k, <a name="_a6"></a><a class="code" href="classkvtest_1_1_callback.html" title="Interface for callbacks from storage APIs.">Callback&lt;GetValue&gt;</a> *c) {
        key = k;
        cb = c;
    }

    <span class="keywordtype">bool</span> execute(<a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a> *db) {
        db-&gt;<a name="a7"></a><a class="code" href="classkvtest_1_1_sqlite3.html#a55a0ce264a506ea484025eb49dcd692c" title="Overrides get().">get</a>(key, *cb);
    }

<span class="keyword">private</span>:
    std::string                         key;
    <a class="code" href="classkvtest_1_1_callback.html" title="Interface for callbacks from storage APIs.">Callback&lt;GetValue&gt;</a> *cb;
};

<span class="keyword">class </span>DeleteOperation : <span class="keyword">public</span> DBOperation {
<span class="keyword">public</span>:

    DeleteOperation(std::string &amp;k, <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *c) {
        key = k;
        cb = c;
    }

    <span class="keywordtype">bool</span> execute(<a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a> *db) {
        db-&gt;<a name="a8"></a><a class="code" href="classkvtest_1_1_sqlite3.html#a160561b2734fbea8e66f1de984c631e5" title="Overrides del().">del</a>(key, *cb);
    }

<span class="keyword">private</span>:
    std::string             key;
    <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> *cb;
};

<span class="keyword">class </span>InboundQueue {
<span class="keyword">public</span>:
    InboundQueue() {
        pthread_mutex_init(&amp;mutex, NULL);
        pthread_cond_init(&amp;cond, NULL);
    }

    ~InboundQueue() {
        pthread_cond_destroy(&amp;cond);
        pthread_mutex_destroy(&amp;mutex);
    }

    <span class="keywordtype">void</span> addOperation(DBOperation *op) {
        <a name="_a9"></a><a class="code" href="classkvtest_1_1_lock_holder.html" title="pthread mutex holder (maintains lock while active).">LockHolder</a> lh(&amp;mutex);
        ops.push(op);
        <span class="keywordflow">if</span>(pthread_cond_signal(&amp;cond) != 0) {
            <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Error signaling change.&quot;</span>);
        }
    }

    <span class="keywordtype">void</span> drainTo(std::queue&lt;DBOperation*&gt; &amp;out) {
        <a class="code" href="classkvtest_1_1_lock_holder.html" title="pthread mutex holder (maintains lock while active).">LockHolder</a> lh(&amp;mutex);
        <span class="keywordflow">if</span>(ops.empty()) {
            <span class="keywordflow">if</span>(pthread_cond_wait(&amp;cond, &amp;mutex) != 0) {
                <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Error waiting for signal.&quot;</span>);
            }
        }
        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0; i &lt; MAX_DRAIN &amp;&amp; !ops.empty(); i++) {
            out.push(ops.front());
            ops.pop();
        }
    }

<span class="keyword">private</span>:
    pthread_mutex_t          mutex;
    pthread_cond_t           cond;
    std::queue&lt;DBOperation*&gt; ops;
};

<span class="keyword">class </span>QueryExecutor {
<span class="keyword">public</span>:
    QueryExecutor(<a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a> *d, InboundQueue *q) {
        db = d;
        iq = q;
        running = <span class="keyword">true</span>;
    }

    <span class="keywordtype">void</span> run() {
        <span class="keywordflow">while</span>(running) {
            std::queue&lt;DBOperation*&gt; ops;
            iq-&gt;drainTo(ops);
            db-&gt;<a name="a10"></a><a class="code" href="classkvtest_1_1_sqlite3.html#a09b9ca2cd99d9bfb0725cc9f72382ef4" title="Begin a transaction (if not already in one).">begin</a>();
            <span class="keywordtype">int</span> count = 0;

            <span class="keywordflow">while</span>(!ops.empty()) {
                DBOperation *op = ops.front();
                ops.pop();

                op-&gt;execute(db);
                count++;
            }

            db-&gt;<a name="a11"></a><a class="code" href="classkvtest_1_1_sqlite3.html#ab9c8148eafd157cefe228d35f72d89db" title="Commit a transaction (unless not currently in one).">commit</a>();
        }
    }

<span class="keyword">private</span>:
    <span class="keywordtype">bool</span>          running;
    <a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a>      *db;
    InboundQueue *iq;
};

<span class="keyword">static</span> <span class="keywordtype">void</span>* launch_executor_thread(<span class="keywordtype">void</span>* arg) {
    QueryExecutor *executor = (QueryExecutor*) arg;
    <span class="keywordflow">try</span> {
        executor-&gt;run();
    } <span class="keywordflow">catch</span>(...) {
        std::cerr &lt;&lt; <span class="stringliteral">&quot;Caught a fatal exception in the thread&quot;</span> &lt;&lt; std::endl;
    }
}

<span class="keyword">class </span>QueuedSqlite : <span class="keyword">public</span> <a name="_a12"></a><a class="code" href="classkvtest_1_1_thing_under_test.html" title="An individual kv storage (or way to access a kv storage).">ThingUnderTest</a> {
<span class="keyword">public</span>:

    QueuedSqlite(<span class="keyword">const</span> <span class="keywordtype">char</span> *path) {
        db = <span class="keyword">new</span> <a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a>(path);
        iq = <span class="keyword">new</span> InboundQueue();
        executor = <span class="keyword">new</span> QueryExecutor(db, iq);

        <span class="keywordflow">if</span>(pthread_create(&amp;thread, NULL, launch_executor_thread, executor)
           != 0) {
            <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Error initializing queue thread&quot;</span>);
        }
    }

    ~QueuedSqlite() {
        <span class="keyword">delete</span> db;
        <span class="keyword">delete</span> iq;
        <span class="keyword">delete</span> executor;
    }

    <span class="keywordtype">void</span> <a name="a13"></a><a class="code" href="classkvtest_1_1_thing_under_test.html#ac74abe36b8ed287e2f89d6994cd748f9" title="Called after each test to reinitialize the test.">reset</a>() {
        std::queue&lt;DBOperation*&gt; opq;
        <a name="_a14"></a><a class="code" href="classkvtest_1_1_remembering_callback.html" title="Threadsafe callback implementation that just captures the value.">RememberingCallback&lt;bool&gt;</a> cb;
        iq-&gt;addOperation(<span class="keyword">new</span> ResetOperation(&amp;cb));
        cb.<a name="a15"></a><a class="code" href="classkvtest_1_1_remembering_callback.html#a4419e86f41c4a17373c75c15cc9bcbd7" title="Wait for a value to be available.">waitForValue</a>();
    }

    <span class="keywordtype">void</span> <span class="keyword">set</span>(std::string &amp;key, std::string &amp;val,
             <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> &amp;cb) {
        iq-&gt;addOperation(<span class="keyword">new</span> SetOperation(key, val, &amp;cb));
    }

    <span class="keywordtype">void</span> <span class="keyword">get</span>(std::string &amp;key, <a class="code" href="classkvtest_1_1_callback.html" title="Interface for callbacks from storage APIs.">Callback&lt;GetValue&gt;</a> &amp;cb) {
        iq-&gt;addOperation(<span class="keyword">new</span> GetOperation(key, &amp;cb));
    }

    <span class="keywordtype">void</span> <a name="a16"></a><a class="code" href="classkvtest_1_1_thing_under_test.html#a90b1b2a9a45cd232900a00c7d343258c" title="Delete a value for a key.">del</a>(std::string &amp;key, <a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> &amp;cb) {
        iq-&gt;addOperation(<span class="keyword">new</span> DeleteOperation(key, &amp;cb));
    }

    <span class="keywordtype">void</span> <a name="a17"></a><a class="code" href="classkvtest_1_1_thing_under_test.html#ade63e2b26cce8b50d4b78ee6b3e348f3" title="Method that should not return until the driver has done its job.">noop</a>(<a class="code" href="classkvtest_1_1_callback.html">Callback&lt;bool&gt;</a> &amp;cb) {
        iq-&gt;addOperation(<span class="keyword">new</span> NOOPOperation(&amp;cb));
    }

<span class="keyword">private</span>:
    <a class="code" href="classkvtest_1_1_sqlite3.html" title="The sqlite driver.">Sqlite3</a>       *db;
    InboundQueue  *iq;
    QueryExecutor *executor;
    pthread_t      thread;
};

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **args) {
    QueuedSqlite *thing = <span class="keyword">new</span> QueuedSqlite(<span class="stringliteral">&quot;/tmp/test.db&quot;</span>);

    <a name="_a18"></a><a class="code" href="classkvtest_1_1_test_suite.html" title="A series of tests to run.">TestSuite</a> suite(thing);
    <span class="keywordflow">return</span> suite.run() ? 0 : 1;
}
</pre></div> </div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Thu Oct 1 23:18:09 2009 for kvtest by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
